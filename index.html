<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Medição de Válvulas do Scania-550</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <h1>Medição de Válvulas do Scania-550</h1>
  
  <label>Mecânico: <input type="text" id="mecanico" /></label><br>
  <label>UGD: <input type="text" id="ugd" /></label><br>
  <label>Usina: <input type="text" id="usina" /></label><br>
  <label>Série: <input type="text" id="serie" /></label><br>
  <label>O.S: <input type="text" id="os" /></label><br>
  <label>Data: <input type="date" id="data" /></label><br>
  <label>Horímetro: <input type="text" id="horimetro" /></label><br>

  <!-- Exemplo de alguns campos de medição -->
  <label>Exaustão 1.1: <input type="text" id="exaustao1_1" /></label><br>
  <label>Exaustão 1.2: <input type="text" id="exaustao1_2" /></label><br>
  <label>Admissão 1.1: <input type="text" id="admissao1_1" /></label><br>
  <label>Admissão 1.2: <input type="text" id="admissao1_2" /></label><br>
  
  <!-- Replique os outros campos conforme seu projeto -->

  <label>Observações:<br>
    <textarea id="observacoes" rows="5" cols="50"></textarea>
  </label><br>

  <label>Assinatura: <input type="text" id="assinatura" /></label><br>

  <button id="generatePdf">Gerar PDF</button>
  <button id="clearBtn">Limpar</button>

  <script>
    const { jsPDF } = window.jspdf;

    function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
      const words = text.split(' ');
      let line = '';
      let linesCount = 0;

      for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        const testWidth = metrics.width;
        if (testWidth > maxWidth && n > 0) {
          ctx.fillText(line, x, y + linesCount * lineHeight);
          line = words[n] + ' ';
          linesCount++;
        } else {
          line = testLine;
        }
      }
      ctx.fillText(line, x, y + linesCount * lineHeight);
    }

    document.getElementById('generatePdf').addEventListener('click', async function () {
      const img = new Image();
      img.src = 'background.jpg';
      img.crossOrigin = 'Anonymous';

      await new Promise((resolve) => { img.onload = resolve; });

      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');

      ctx.drawImage(img, 0, 0);

      ctx.font = 'bold 18px Arial';
      ctx.fillStyle = '#000000';
      ctx.textAlign = 'left';

      ctx.fillText(document.getElementById('mecanico').value || '', 208, 235);
      ctx.fillText(document.getElementById('usina').value || '', 186, 263);
      ctx.fillText(document.getElementById('serie').value || '', 198, 290);
      ctx.fillText(document.getElementById('os').value || '', 267, 321);

      const ugdVal = document.getElementById('ugd').value;
      ctx.fillText(ugdVal ? `UGD- ${ugdVal}` : '', 229, 204);

      const dataValue = document.getElementById('data').value;
      if (dataValue) {
        const dataFormatada = new Date(dataValue).toLocaleDateString('pt-BR');
        ctx.fillText(dataFormatada, 808, 263);
      }

      ctx.fillText(document.getElementById('horimetro').value || '', 753, 290);

      const limiteMaximo = 67.5;

      const campos = [
        ['exaustao1_1', 146, 553], ['exaustao1_2', 147, 518],
        ['admissao1_1', 357, 553], ['admissao1_2', 351, 518]
        // Adicione os outros campos que você já mapeou aqui
      ];

      campos.forEach(([id, x, y]) => {
        const valStr = document.getElementById(id)?.value || '';
        const valNum = parseFloat(valStr.replace(',', '.'));

        if (!isNaN(valNum) && valNum >= limiteMaximo) {
          ctx.fillStyle = '#cc0000'; // vermelho
          ctx.font = 'bold 18px Arial'; // negrito
        } else {
          ctx.fillStyle = '#000000';
          ctx.font = 'normal 18px Arial';
        }

        ctx.fillText(valStr, x, y);
      });

      const observacoes = document.getElementById('observacoes').value;
      wrapText(ctx, observacoes, 183, 1033, 900, 24);

      ctx.font = 'italic 32px Brush Script MT, cursive, Arial';
      ctx.fillStyle = '#000000';
      ctx.fillText(document.getElementById('assinatura').value || '', 820, 1320);

      const pdf = new jsPDF({ unit: 'mm', format: 'a4' });
      const imgData = canvas.toDataURL('image/png');
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();
      const scale = Math.min(pdfWidth / canvas.width, pdfHeight / canvas.height);
      const imgWidth = canvas.width * scale;
      const imgHeight = canvas.height * scale;
      const x = (pdfWidth - imgWidth) / 2;
      const y = 10;

      pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
      pdf.save('medicao-valvulas.pdf');
    });

    document.getElementById('clearBtn').addEventListener('click', function () {
      const inputs = document.querySelectorAll('input[type="text"], input[type="date"], textarea');
      inputs.forEach(input => input.value = '');
    });
  </script>
</body>
</html>
