<script>
  const { jsPDF } = window.jspdf;

  document.getElementById('generatePdf').addEventListener('click', async function() {
    const img = new Image();
    img.src = 'background.jpg';
    img.crossOrigin = 'Anonymous';

    await new Promise((resolve) => { img.onload = resolve; });

    const canvas = document.createElement('canvas');
    canvas.width = img.width;
    canvas.height = img.height;
    const ctx = canvas.getContext('2d');

    ctx.drawImage(img, 0, 0);

    ctx.font = 'bold 28px Arial';
    ctx.fillStyle = '#000000';
    ctx.textAlign = 'left';

    // Informações principais
    ctx.fillText(document.getElementById('mecanico').value || '', 230, 125);
    ctx.fillText(document.getElementById('usina').value || '', 230, 175);
    ctx.fillText(document.getElementById('serie').value || '', 230, 225);
    ctx.fillText(document.getElementById('os').value || '', 230, 275);

    const dataValue = document.getElementById('data').value;
    if (dataValue) {
      const dataFormatada = new Date(dataValue).toLocaleDateString('pt-BR');
      ctx.fillText(dataFormatada, 830, 125);
    }

    ctx.fillText(document.getElementById('horimetro').value || '', 830, 175);

    // Coordenadas ajustadas com base na imagem do formulário
    const campos = [
      ['exaustao1_1', 107, 468], ['exaustao1_2', 107, 493], ['admissao1_1', 256, 468], ['admissao1_2', 256, 493],
      ['exaustao5_1', 378, 468], ['exaustao5_2', 378, 493], ['admissao5_1', 525, 468], ['admissao5_2', 525, 493],
      ['exaustao3_1', 648, 468], ['exaustao3_2', 648, 493], ['admissao3_1', 794, 468], ['admissao3_2', 794, 493],

      ['exaustao6_1', 107, 640], ['exaustao6_2', 107, 666], ['admissao6_1', 256, 640], ['admissao6_2', 256, 666],
      ['exaustao2_1', 378, 640], ['exaustao2_2', 378, 666], ['admissao2_1', 525, 640], ['admissao2_2', 525, 666],
      ['exaustao4_1', 648, 640], ['exaustao4_2', 648, 666], ['admissao4_1', 794, 640], ['admissao4_2', 794, 666]
    ];

    campos.forEach(([id, x, y]) => {
      const val = document.getElementById(id)?.value || '';
      ctx.fillText(val, x, y);
    });

    // Observações (ajustadas)
    const observacoes = document.getElementById('observacoes').value.split('\n');
    observacoes.forEach((linha, i) => {
      ctx.fillText(linha, 107, 820 + i * 30); // posição corrigida
    });

    // Criar PDF
    const pdf = new jsPDF({
      orientation: 'portrait',
      unit: 'px',
      format: [img.width, img.height]
    });

    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    pdf.addImage(imgData, 'JPEG', 0, 0, img.width, img.height);
    pdf.save('medicao_valvulas_scania.pdf');
  });

  // Botão Limpar
  document.getElementById('clearBtn').addEventListener('click', function () {
    const inputs = document.querySelectorAll('input[type="text"], input[type="date"], textarea');
    inputs.forEach(input => input.value = '');
  });
</script>
